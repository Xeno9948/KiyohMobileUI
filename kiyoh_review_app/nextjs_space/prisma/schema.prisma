generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Company {
  id            String    @id @default(cuid())
  name          String
  locationId    String
  apiToken      String
  tenantId      String    @default("98")
  baseUrl       String    @default("https://www.kiyoh.com")
  isActive      Boolean   @default(true)
  aiEnabled     Boolean   @default(true)
  strongPoints  String?   // JSON array of AI-detected strong points
  
  // Google My Business Integration
  gmbEnabled       Boolean   @default(false)
  gmbAccountId     String?
  gmbLocationId    String?
  gmbAccessToken   String?   // Encrypted OAuth access token
  gmbRefreshToken  String?   // Encrypted OAuth refresh token
  gmbTokenExpiry   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  users         User[]
  invites       ReviewInvite[]
  notifications ReviewNotification[]
  gmbReviews    GMBReview[]

  @@unique([locationId])
  @@index([locationId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String
  role          String    @default("user")
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])
  lastLoginAt   DateTime?
  resetToken    String?
  resetTokenExp DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  invites       ReviewInvite[]

  @@index([companyId])
  @@index([role])
}

model ReviewInvite {
  id            String    @id @default(cuid())
  email         String
  firstName     String?
  lastName      String?
  refCode       String?
  language      String    @default("en")
  delay         Int       @default(0)
  status        String    @default("sent")
  createdAt     DateTime  @default(now())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])

  @@index([email])
  @@index([createdAt])
  @@index([companyId])
}

model ReviewNotification {
  id                String    @id @default(cuid())
  reviewId          String
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id])
  reviewAuthor      String?
  reviewRating      Float?
  reviewText        String?
  reviewDate        DateTime?
  suggestedResponse String?
  status            String    @default("pending") // pending, approved, dismissed
  isRead            Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([reviewId, companyId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
}

model SystemSettings {
  id              String   @id @default("global")
  aiProvider      String   @default("openai") // openai, anthropic, abacus
  aiApiKey        String?
  aiModel         String   @default("gpt-4-turbo")
  updatedAt       DateTime @updatedAt
}

model GMBReview {
  id              String    @id @default(cuid())
  reviewId        String    @unique  // GMB review ID
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviewer        String?   // Reviewer display name
  starRating      String?   // ONE, TWO, THREE, FOUR, FIVE
  comment         String?   // Review text
  createTime      DateTime? // When review was created
  updateTime      DateTime? // Last update time
  reviewReply     String?   // Business reply text
  replyUpdateTime DateTime? // When reply was last updated
  lastSyncedAt    DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([companyId])
  @@index([createTime])
  @@index([starRating])
}